<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>App.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nutritionGen</a> &gt; <a href="index.source.html" class="el_package">lamar.app</a> &gt; <span class="el_source">App.java</span></div><h1>App.java</h1><pre class="source lang-java linenums">package lamar.app;

import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Scanner;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import lamar.database.Database;
import lamar.database.Pair;
import lamar.database.nutrient.Catagory;
import lamar.database.nutrient.Nutrient;
import lamar.database.nutrient.NutrientProvider;
import lamar.database.nutrient.ProviderFactory;
import lamar.scraper.UsdaScraper;
 
/**
 *
 * @author sqlitetutorial.net
 */
<span class="nc" id="L25">public class App {</span>

  private static final String DB_NAME = &quot;nutritionGen.db&quot;;
  private static final int MAX_SEARCH_SZ = 20;

  // Consumes the whole line on every token consumption. Makes getting numericals easier. Do not use
  // nextLine.
  private static Scanner stdn;
  static {
<span class="nc" id="L34">    stdn = new Scanner(System.in);</span>
<span class="nc" id="L35">    String nl = System.getProperty(&quot;line.separator&quot;);</span>
<span class="nc" id="L36">    nl = nl.replaceAll(&quot;\\\\&quot;, &quot;\\\\&quot;);</span>
<span class="nc" id="L37">    stdn.useDelimiter(nl);</span>
<span class="nc" id="L38">  }</span>

  /**
  * @param args the command line arguments
  */
  public static void main(String[] args) {

<span class="nc bnc" id="L45" title="All 2 branches missed.">    if(args.length == 0) {</span>
<span class="nc" id="L46">      System.err.println(&quot;Expects database destination dir as arg&quot;);</span>
<span class="nc" id="L47">      System.exit(1);</span>
    }

<span class="nc" id="L50">    String dbLoc = args[0];</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">    if(!dbLoc.matches(&quot;/$&quot;)) {</span>
<span class="nc" id="L52">      dbLoc += &quot;/&quot;;</span>
    }
<span class="nc" id="L54">    try(Database db = Database.createIfAbsent(dbLoc + DB_NAME)) {</span>
<span class="nc" id="L55">      System.out.println(&quot;Database created or initialized at &quot; + args[0]);</span>

<span class="nc" id="L57">      String[] options = { &quot;add&quot;, &quot;lookup&quot; };</span>
<span class="nc" id="L58">      boolean again = true;</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">      while(again) {</span>

<span class="nc bnc" id="L61" title="All 4 branches missed.">        switch(getMenuSelect(options, &quot;exit&quot;)) {</span>
          case 0:
<span class="nc" id="L63">            System.exit(0);</span>
          case 1: 
<span class="nc" id="L65">            addEntry(db);</span>
<span class="nc" id="L66">            continue;</span>
          case 2: 
<span class="nc" id="L68">            lookupEntry(db);</span>
<span class="nc" id="L69">            continue;</span>
          default: break;
        }

<span class="nc" id="L73">        again = getResponse(&quot;again&quot;);</span>
      }

<span class="nc" id="L76">    } catch(Exception e) {</span>
<span class="nc" id="L77">      System.err.println(e.getMessage());</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">      if(getResponse(&quot;show log&quot;)) {</span>
<span class="nc" id="L79">        e.printStackTrace();</span>
      }
<span class="nc" id="L81">    }</span>

<span class="nc" id="L83">  }</span>

  private static void lookupEntry(Database db) throws SQLException, IOException {
    
<span class="nc" id="L87">    boolean again = true;</span>
<span class="nc" id="L88">    String[] options = Arrays.stream(Catagory.values())</span>
<span class="nc" id="L89">        .map(x -&gt; x.toString())</span>
<span class="nc" id="L90">        .toArray(String[]::new);</span>
<span class="nc" id="L91">    Catagory[] types = Catagory.values();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">    while(again) {</span>

<span class="nc" id="L94">      int selection = getMenuSelect(options, &quot;back&quot;);</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">      if(selection &gt;= 1) {</span>
<span class="nc" id="L96">        List&lt;NutrientProvider&gt; entries = db.getType(types[selection - 1]);</span>
        
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if(entries.isEmpty()) {</span>
<span class="nc" id="L99">          System.out.println(&quot;Empty&quot;);</span>
        } else
<span class="nc" id="L101">          expandProv(entries, db);</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        } else if(selection == 0) {</span>
<span class="nc" id="L103">          again = false;</span>
        } else {
<span class="nc" id="L105">          again = getResponse(&quot;again&quot;);</span>
        }
<span class="nc" id="L107">      }</span>
<span class="nc" id="L108">  }</span>

  private static void expandProv(List&lt;NutrientProvider&gt; list, Database db) throws SQLException, IOException {
<span class="nc" id="L111">    String[] options = list.stream()</span>
<span class="nc" id="L112">        .map(x -&gt; x.getName())</span>
<span class="nc" id="L113">        .toArray(String[]::new);</span>

<span class="nc" id="L115">    int selection = getMenuSelect(options, &quot;back&quot;);  </span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">    if(selection &gt;= 1) {</span>
<span class="nc" id="L117">      NutrientProvider prov = list.get(selection - 1);</span>
<span class="nc" id="L118">      System.out.println(prov.label() + &quot;\n&quot;);</span>

<span class="nc" id="L120">      Catagory type = prov.getType();</span>

<span class="nc bnc" id="L122" title="All 2 branches missed.">      options = type == Catagory.INGREDIENT ? </span>
          new String[] { &quot;remove&quot; } :
          new String[] { &quot;remove&quot;, &quot;lookup ingredient value&quot; };

<span class="nc" id="L126">      selection = getMenuSelect(options, &quot;back&quot;);</span>
<span class="nc bnc" id="L127" title="All 3 branches missed.">      switch(selection) {</span>
        case 1: 
<span class="nc" id="L129">          removeEntry(prov, db); </span>
<span class="nc" id="L130">          break;</span>
        case 2: 
<span class="nc" id="L132">          HashMap&lt;String, Pair&lt;Catagory, Double&gt;&gt; constituent = prov.getConstituent(); </span>
<span class="nc" id="L133">          List&lt;NutrientProvider&gt; newList = new ArrayList&lt;&gt;(constituent.size());</span>
          
<span class="nc bnc" id="L135" title="All 2 branches missed.">          for(String ingr : constituent.keySet()) {</span>
<span class="nc" id="L136">            Pair&lt;Catagory, Double&gt; p = constituent.get(ingr);</span>
<span class="nc" id="L137">            newList.add(db.get(p.getValue0(), ingr));</span>
<span class="nc" id="L138">          }</span>
<span class="nc" id="L139">          expandProv(newList, db);</span>
          break;
      }
    }
<span class="nc" id="L143">  }</span>

  private static void removeEntry(NutrientProvider prov, Database db) throws SQLException, IOException {
<span class="nc" id="L146">    String msg = &quot;Warning: This operation will delete all entries which are dependent on this one.&quot;</span>
        + &quot;\ncontinue&quot;;
<span class="nc bnc" id="L148" title="All 2 branches missed.">    if(getResponse(msg)) {</span>
<span class="nc" id="L149">      db.remove(prov);</span>
    }
<span class="nc" id="L151">  }</span>

  private static void addEntry(Database db) throws IOException, SQLException {
<span class="nc" id="L154">    String options[] = new String[] { &quot;from web&quot;, &quot;manually&quot; };</span>

<span class="nc" id="L156">    int selection = getMenuSelect(options, &quot;end&quot;);</span>
<span class="nc" id="L157">    ProviderFactory fctry = new ProviderFactory();</span>
    
<span class="nc bnc" id="L159" title="All 2 branches missed.">    if(selection &gt;= 0) {</span>
<span class="nc bnc" id="L160" title="All 4 branches missed.">      switch(selection) {</span>
        case 0: 
<span class="nc" id="L162">          break;</span>
        case 1: 
<span class="nc" id="L164">          addEntryWeb(db, fctry);</span>
<span class="nc" id="L165">          break;</span>
        case 2:
<span class="nc" id="L167">          addEntryUser(db, fctry);</span>
          break;
      }
    }

<span class="nc bnc" id="L172" title="All 2 branches missed.">    if(fctry.validate()) {</span>
<span class="nc" id="L173">      System.out.println(&quot;Entry added successfully&quot;);</span>
<span class="nc" id="L174">      db.add(fctry.build());</span>
    } else {
<span class="nc" id="L176">      System.out.println(&quot;Entry NOT added successfully&quot;);</span>
    }
<span class="nc" id="L178">  }</span>

  private static void addEntryWeb(Database db, ProviderFactory fctry) throws IOException, SQLException {
<span class="nc" id="L181">    String searchTerm = getStringIO(&quot;Enter a term for web search&quot;); </span>
<span class="nc" id="L182">    HashMap&lt;Pair&lt;String, String&gt;, Integer&gt; rslt = UsdaScraper.getSearchResults(searchTerm);    </span>
<span class="nc" id="L183">    List&lt;Pair&lt;String, String&gt;&gt; ks = rslt.keySet().stream()</span>
<span class="nc" id="L184">        .collect(Collectors.toList());</span>

<span class="nc" id="L186">    String[] options = ks.stream()</span>
<span class="nc" id="L187">        .limit(MAX_SEARCH_SZ)</span>
<span class="nc" id="L188">        .map(x -&gt; x.toString())</span>
<span class="nc" id="L189">        .toArray(String[]::new);</span>

<span class="nc" id="L191">    int selection = getMenuSelect(options, &quot;back&quot;);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">    if(selection &lt;= 0) {</span>
<span class="nc" id="L193">      return;</span>
    }

<span class="nc" id="L196">    int id = rslt.get(ks.get(selection - 1));</span>
<span class="nc" id="L197">    UsdaScraper.getIngredient(id, fctry);</span>

<span class="nc" id="L199">    addEntryUser(db, fctry);</span>
<span class="nc" id="L200">  }</span>

  private static void addEntryUser(Database db, ProviderFactory fctry) throws IOException, SQLException {
<span class="nc" id="L203">    boolean again = true;</span>

<span class="nc" id="L205">    String[] baseAction = new String[] { &quot;name&quot;, &quot;unit&quot;, &quot;per&quot;, &quot;type&quot; };</span>
<span class="nc" id="L206">    int typeVal = -1;</span>

<span class="nc bnc" id="L208" title="All 2 branches missed.">    while(again) {</span>

<span class="nc" id="L210">      Catagory type = fctry.getType();</span>
<span class="nc bnc" id="L211" title="All 4 branches missed.">      if(type != null &amp;&amp; type.p != typeVal) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        baseAction = type.p == Catagory.INGREDIENT.p ?  </span>
            new String[] { &quot;name&quot;, &quot;unit&quot;, &quot;per&quot;, &quot;type&quot;, &quot;values&quot;} :
            new String[] { &quot;name&quot;, &quot;unit&quot;, &quot;per&quot;, &quot;type&quot;, &quot;ingredients&quot;};

      }

<span class="nc" id="L218">      System.out.println(fctry.label());</span>
<span class="nc" id="L219">      int selection = getMenuSelect(baseAction, &quot;end&quot;);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">      if(selection &gt;= 0) {</span>

<span class="nc bnc" id="L222" title="All 7 branches missed.">        switch(selection) {</span>
          case 0 :
<span class="nc" id="L224">            again = false;</span>
<span class="nc" id="L225">            break;</span>
          case 1 :
<span class="nc" id="L227">            fctry.setName(getStringIO(&quot;Enter provider name&quot;));</span>
<span class="nc" id="L228">            break;</span>
          case 2 :
<span class="nc" id="L230">            fctry.setUnit(getStringIO(&quot;Enter unit of measure&quot;));</span>
<span class="nc" id="L231">            break;</span>
          case 3 :
<span class="nc" id="L233">            fctry.setPerUnit(validateGetInt(&quot;Enter multiplicity of unit measure&quot;, 0, Integer.MAX_VALUE));</span>
<span class="nc" id="L234">            break;</span>
          case 4 : 
<span class="nc" id="L236">            fctry.setType(getTypeIO(&quot;Select provider type&quot;));</span>
<span class="nc" id="L237">            break;</span>
          case 5 : 
<span class="nc bnc" id="L239" title="All 2 branches missed.">            if(type.p == Catagory.INGREDIENT.p) {</span>
<span class="nc" id="L240">              fctry.setTable(getIngredientIO(&quot;Fill in ingredient table&quot;));</span>
            } else {
<span class="nc" id="L242">              fctry.setConstituent(getConstituentIO(&quot;Enter as: type, name&quot;, db));</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">              if(fctry.getConstituent().isEmpty()) {</span>
<span class="nc" id="L244">                break;</span>
              }
<span class="nc" id="L246">              fctry.buildCompositeTable();</span>
            }
<span class="nc" id="L248">            break;</span>
          default : 
<span class="nc" id="L250">            again = false;</span>
        }
      } else {
<span class="nc" id="L253">        again = getResponse(&quot;again&quot;);</span>
      }
<span class="nc" id="L255">    }</span>
<span class="nc" id="L256">  }</span>

  private static String getStringIO(String msg) {
<span class="nc" id="L259">    System.out.println(msg);</span>
<span class="nc" id="L260">    return stdn.next();</span>
  }

  private static Catagory getTypeIO(String msg) {
<span class="nc" id="L264">    System.out.println(msg);</span>

<span class="nc" id="L266">    Catagory[] types = Catagory.values();</span>
<span class="nc" id="L267">    String[] options =  Arrays.stream(types)</span>
<span class="nc" id="L268">        .map(x -&gt; x.toString())</span>
<span class="nc" id="L269">        .toArray(String[]::new);</span>
<span class="nc" id="L270">    int v = getMenuSelect(options, &quot;&quot;);</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">    return v &lt;= 0 ? null : types[v - 1]; </span>
  }

  private static double[] getIngredientIO(String msg) {
<span class="nc" id="L275">    System.out.println(msg);</span>

<span class="nc" id="L277">    Nutrient[] ntr = Nutrient.values();</span>
<span class="nc" id="L278">    double[] table = new double[ntr.length];</span>
<span class="nc" id="L279">    String[] options = Arrays.stream(ntr)</span>
<span class="nc" id="L280">        .map(x -&gt; x.toString())</span>
<span class="nc" id="L281">        .toArray(String[]::new);</span>

<span class="nc" id="L283">    boolean again = true;</span>
<span class="nc" id="L284">    String instrct = &quot;Enter value&quot;;</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">    while(again) {</span>

<span class="nc" id="L287">      int selection = getMenuSelect(options, &quot;back&quot;);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">      if(selection &gt;= 0) {</span>

<span class="nc bnc" id="L290" title="All 8 branches missed.">        switch(selection) {</span>
          case 0 :
<span class="nc" id="L292">            return table;</span>
          case 1 : 
<span class="nc" id="L294">            table[0] = validateGetDouble(instrct, 0, Double.MAX_VALUE);  </span>
<span class="nc" id="L295">            continue; </span>
          case 2 : 
<span class="nc" id="L297">            table[1] = validateGetDouble(instrct, 0, Double.MAX_VALUE);  </span>
<span class="nc" id="L298">            continue; </span>
          case 3 : 
<span class="nc" id="L300">            table[2] = validateGetDouble(instrct, 0, Double.MAX_VALUE);  </span>
<span class="nc" id="L301">            continue; </span>
          case 4 : 
<span class="nc" id="L303">            table[3] = validateGetDouble(instrct, 0, Double.MAX_VALUE);  </span>
<span class="nc" id="L304">            continue; </span>
          case 5 : 
<span class="nc" id="L306">            table[4] = validateGetDouble(instrct, 0, Double.MAX_VALUE);  </span>
<span class="nc" id="L307">            continue; </span>
          case 6 : 
<span class="nc" id="L309">            table[5] = validateGetDouble(instrct, 0, Double.MAX_VALUE);  </span>
<span class="nc" id="L310">            continue; </span>
          default :
            break;
        }
      }

<span class="nc" id="L316">      again = getResponse(&quot;again&quot;);</span>
<span class="nc" id="L317">    }</span>
<span class="nc" id="L318">    return table;</span>
  }

  private static HashMap&lt;NutrientProvider, Pair&lt;Catagory, Double&gt;&gt; 
      getConstituentIO(String msg, Database db) throws SQLException, IOException {

<span class="nc" id="L324">    System.out.println(msg);</span>
<span class="nc" id="L325">    HashMap&lt;NutrientProvider, Pair&lt;Catagory, Double&gt;&gt; constituent = new HashMap&lt;&gt;();</span>
    
<span class="nc" id="L327">    boolean again = true;   </span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">    while(again) {</span>

<span class="nc" id="L330">      Catagory type = getTypeIO(&quot;Select type for lookup query&quot;); </span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">      if(type != null) {</span>
<span class="nc" id="L332">        List&lt;NutrientProvider&gt; value = db.getType(type);</span>
<span class="nc" id="L333">        String[] options = value.stream()</span>
<span class="nc" id="L334">            .map(x -&gt; x.getName())</span>
<span class="nc" id="L335">            .toArray(String[]::new);</span>

<span class="nc" id="L337">        int i = getMenuSelect(options, &quot;back&quot;);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if(i == 0) {</span>
<span class="nc" id="L339">          return constituent;</span>
        }

<span class="nc" id="L342">        i--;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        if(i &gt;= 0) {</span>

<span class="nc" id="L345">          NutrientProvider selection = value.get(i);</span>
<span class="nc" id="L346">          double multiplicty = validateGetDouble(&quot;Enter multiplicty&quot;, 0, Double.MAX_VALUE);</span>
<span class="nc" id="L347">          String name = selection.getName();</span>

<span class="nc bnc" id="L349" title="All 2 branches missed.">          if(db.contains(type, name)) {</span>
<span class="nc" id="L350">           constituent.put(db.get(type, name), new Pair&lt;&gt;(type, multiplicty));</span>
          }
        }
      }

<span class="nc" id="L355">      again = getResponse(&quot;again&quot;);</span>
<span class="nc" id="L356">    }</span>

<span class="nc" id="L358">    return constituent;</span>
  }

  private static int getMenuSelect(String[] options, String escape) {
<span class="nc bnc" id="L362" title="All 2 branches missed.">    if(!escape.isEmpty()) {</span>
<span class="nc" id="L363">      System.out.println(&quot;0: &quot; + escape);</span>
    }
<span class="nc" id="L365">    IntStream.range(0, options.length)</span>
<span class="nc" id="L366">        .forEach(x -&gt; System.out.println((x + 1) + &quot;: &quot; + options[x]));</span>

<span class="nc" id="L368">    int in = validateGetInt(&quot;&quot;, 0, options.length); </span>
<span class="nc" id="L369">    return in;</span>
  }

  private static int validateGetInt(String msg, int start, int end) {
<span class="nc" id="L373">    System.out.println(msg);</span>

<span class="nc" id="L375">    int in = 0;</span>
<span class="nc bnc" id="L376" title="All 2 branches missed.">    if(stdn.hasNextInt()) {</span>

<span class="nc" id="L378">      in = stdn.nextInt();</span>
<span class="nc bnc" id="L379" title="All 4 branches missed.">      if(in &gt;= start &amp;&amp; in &lt;= end) {</span>
<span class="nc" id="L380">        return in;</span>
      }
    }

<span class="nc bnc" id="L384" title="All 2 branches missed.">    String errToken = in == 0 ? stdn.next() : Integer.toString(in);</span>
<span class="nc bnc" id="L385" title="All 2 branches missed.">    if(!errToken.equals(&quot;cancel&quot;)) {</span>
<span class="nc" id="L386">      System.out.println(&quot;input '&quot; + errToken + &quot;' is either invalid or out of range.&quot;); </span>
    }
<span class="nc" id="L388">    return -1;</span>
  }

  private static double validateGetDouble(String msg, double start, double end) {
<span class="nc" id="L392">    System.out.println(msg);</span>
    
<span class="nc" id="L394">    double in = 0;</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">    if(stdn.hasNextDouble()) {</span>

<span class="nc" id="L397">      in = stdn.nextDouble();</span>
<span class="nc bnc" id="L398" title="All 4 branches missed.">      if(in &gt;= start &amp;&amp; in &lt; end) {</span>
<span class="nc" id="L399">        return in;</span>
      }
    }

<span class="nc bnc" id="L403" title="All 2 branches missed.">    String errToken = in == 0 ? stdn.next() : Double.toString(in);</span>
<span class="nc" id="L404">    System.out.println(&quot;input '&quot; + errToken + &quot;' is either invalid or out of range.&quot;); </span>
<span class="nc" id="L405">    return -1;</span>
  }

  private static boolean getResponse(String msg) {
<span class="nc" id="L409">    System.out.println(msg + &quot; y/n&quot;);</span>
<span class="nc" id="L410">    return stdn.next().toLowerCase().matches(&quot;^y.*&quot;);</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>